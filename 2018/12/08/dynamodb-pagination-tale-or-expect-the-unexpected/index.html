<!DOCTYPE html>
<html class="has-navbar-fixed-top">
<head>
    <meta charset="utf-8">
    <title>DynamoDB Pagination Tale Or Expect The Unexpected - JScribbles</title>
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.css">
    <meta name="description" content="Notes and stuff.">
    <meta name="description"
          content="You have lots of pies — 6 savoury and 8 sweet. You take all the sweet pies you can get from the query above. How many do you have?What happens when you try to filter data in DynamoDB?Can you guess the">
    <meta name="keywords" content="dynamodb,aws">
    <meta property="og:type" content="article">
    <meta property="og:title" content="DynamoDB Pagination Tale Or Expect The Unexpected">
    <meta property="og:url"
          content="https://jelena.lv/2018/12/08/dynamodb-pagination-tale-or-expect-the-unexpected/index.html">
    <meta property="og:site_name" content="JScribbles">
    <meta property="og:description"
          content="You have lots of pies — 6 savoury and 8 sweet. You take all the sweet pies you can get from the query above. How many do you have?What happens when you try to filter data in DynamoDB?Can you guess the">
    <meta property="og:locale" content="en">
    <meta property="og:image"
          content="https://jelena.lv/gallery/dynamodb-pagination-tale-or-expect-the-unexpected/header.png">
    <meta property="og:image"
          content="https://jelena.lv/gallery/dynamodb-pagination-tale-or-expect-the-unexpected/pies-table.png">
    <meta property="og:updated_time" content="2018-12-08T12:52:24.369Z">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="DynamoDB Pagination Tale Or Expect The Unexpected">
    <meta name="twitter:description"
          content="You have lots of pies — 6 savoury and 8 sweet. You take all the sweet pies you can get from the query above. How many do you have?What happens when you try to filter data in DynamoDB?Can you guess the">
    <meta name="twitter:image"
          content="https://jelena.lv/gallery/dynamodb-pagination-tale-or-expect-the-unexpected/header.png">
    <meta name="twitter:creator" content="@jshaipuka">
    <meta name="twitter:site" content="jshaipuka">
    <link rel="icon" href="/favicon.ico">
    <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Ovo|Source+Code+Pro">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/css/lightgallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/css/justifiedGallery.min.css">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <script defer src="//use.fontawesome.com/releases/v5.0.8/js/all.js"></script>
</head>
<body>
<nav class="navbar is-transparent is-fixed-top navbar-main" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand"><a class="navbar-item navbar-logo" href="/">JScribbles</a>
            <div class="navbar-burger"><span></span> <span></span> <span></span></div>
        </div>
        <div class="navbar-menu navbar-start"><a class="navbar-item" href="/">Home</a> <a class="navbar-item"
                                                                                          href="/archives">Archives</a>
        </div>
        <div class="navbar-menu navbar-end"><a class="navbar-item search" title="Search" href="javascript:;"><i
                class="fas fa-search"></i> </a><a class="navbar-item" title="Twitter"
                                                  href="https://twitter.com/jshaipuka"><i
                class="fab fa-twitter"></i></a></div>
    </div>
</nav>
<section class="section">
    <div class="container">
        <article class="article content gallery" itemscope itemprop="blogPost"><h1
                class="article-title is-size-3 is-size-4-mobile" itemprop="name">DynamoDB Pagination Tale Or Expect The
            Unexpected</h1>
            <div class="article-meta columns is-variable is-1 is-multiline is-mobile is-size-7-mobile"><span
                    class="column is-narrow"><time datetime="2018-12-08T10:49:10.000Z" itemprop="datePublished">Dec 8 2018</time> </span><span
                    class="column is-narrow article-category"><i class="far fa-folder"></i> <a
                    class="article-category-link" href="/categories/aws/">AWS</a> </span><span class="column is-narrow">9 minutes read (About 1290 words)</span>
            </div>
            <div class="article-entry is-size-6-mobile" itemprop="articleBody"><img
                    src="/gallery/dynamodb-pagination-tale-or-expect-the-unexpected/header.png" width="1500"
                    height="1500" title="code">
                <p>You have lots of pies — <em>6 savoury</em> and <em>8 sweet</em>. You take all the sweet pies you can
                    get from the query above. How many do you have?</p>
                <p>What happens when you try to filter data in DynamoDB?</p>
                <p>Can you guess the answer already?</p><a id="more"></a>
                <h1 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h1>
                <p>Looking at the query the most obvious answer comes to mind. <em>It should be 2 pies</em>. Query sets
                    a limit of two so that’s what you have.</p>
                <p>Well… Might be, might not be. <code>limit</code> might not be what you think it is. And the answer
                    lies in how DynamoDB API implements it’s interface.</p>
                <p>We will take a look on how to make our data queries more <em>predictable</em>.</p>
                <h1 id="Data-Set"><a href="#Data-Set" class="headerlink" title="Data Set"></a>Data Set</h1>
                <p>First of all we need a table and some data in it.</p>
                <p>To create a table we need to specify a primary key. It can either consist of a partition key or both
                    a partition key and a sort key. We will go with the latter option:</p>
                <p><em>id</em> — As partition key of type number.</p>
                <p><em>name</em> — As sort key of type string.</p>
                <p>And here they are as as parameters for the <code>create-table</code> command:</p>
                <figure class="highlight json hljs">
                    <figcaption><span>create-table-pies.json</span><a
                            href="https://github.com/jshaipuka/jblog/blob/master/source/downloads/dynamo-db/create-table-pies.json"
                            target="_blank" rel="noopener">View on Github</a></figcaption>
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line marked">&#123;</span><br><span class="line">    <span
                                        class="attr hljs-attr">"TableName"</span>: <span class="string hljs-string">"pies"</span>,</span><br><span
                                        class="line marked">    <span
                                        class="attr hljs-attr">"KeySchema"</span>: [</span><br><span
                                        class="line marked">      &#123; <span
                                        class="attr hljs-attr">"AttributeName"</span>: <span class="string hljs-string">"id"</span>, <span
                                        class="attr hljs-attr">"KeyType"</span>: <span
                                        class="string hljs-string">"HASH"</span> &#125;,</span><br><span class="line">      &#123; <span
                                        class="attr hljs-attr">"AttributeName"</span>: <span class="string hljs-string">"name"</span>, <span
                                        class="attr hljs-attr">"KeyType"</span>: <span class="string hljs-string">"RANGE"</span> &#125;</span><br><span
                                        class="line">    ],</span><br><span class="line">    <span
                                        class="attr hljs-attr">"AttributeDefinitions"</span>: [</span><br><span
                                        class="line">      &#123; <span
                                        class="attr hljs-attr">"AttributeName"</span>: <span class="string hljs-string">"id"</span>, <span
                                        class="attr hljs-attr">"AttributeType"</span>: <span class="string hljs-string">"N"</span> &#125;,</span><br><span
                                        class="line">      &#123; <span
                                        class="attr hljs-attr">"AttributeName"</span>: <span class="string hljs-string">"name"</span>, <span
                                        class="attr hljs-attr">"AttributeType"</span>: <span class="string hljs-string">"S"</span> &#125;</span><br><span
                                        class="line">    ],</span><br><span class="line">    <span
                                        class="attr hljs-attr">"ProvisionedThroughput"</span>: &#123;</span><br><span
                                        class="line">      <span
                                        class="attr hljs-attr">"ReadCapacityUnits"</span>: <span
                                        class="number hljs-number">1</span>,</span><br><span class="line">      <span
                                        class="attr hljs-attr">"WriteCapacityUnits"</span>: <span
                                        class="number hljs-number">1</span></span><br><span
                                        class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p><code>KeyShema</code> attribute is our primary key definition, the <code>AttributeDefinitions</code>
                    attribute is the types of our composite primary key and the last attribute <code>ProvisionedThroughput</code>
                    is related to how much reads and writes DynamoDB will be processing per second. Reads and writes are
                    set to minimal capacities because our dataset is rather small.</p>
                <p>Run this command to create the table:</p>
                <figure class="highlight bash hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">aws dynamodb create-table --cli-input-json file://create-table-pies.json</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <h2 id="Loading-data"><a href="#Loading-data" class="headerlink" title="Loading data"></a>Loading data
                </h2>
                <p>We will batch load sample data as shown below where <code>pies</code> is the table name and <code>PutRequest</code>
                    is the action we want to perform.</p>
                <blockquote class="colorquote info">Notice how the item attributes have to explicitly specify their
                    types in DynamoDB fashion. E.g. <b>id</b> don't just have it's value set directly but with a type
                    attribute: <b>"id": { "N": "1" }</b>.
                </blockquote>
                <figure class="highlight json hljs">
                    <figcaption><span>load-data-pies.json</span><a
                            href="https://github.com/jshaipuka/jblog/blob/master/source/downloads/dynamo-db/load-data-pies.json"
                            target="_blank" rel="noopener">View on Github</a></figcaption>
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line marked">&#123;</span><br><span class="line">  <span
                                        class="attr hljs-attr">"pies"</span>: [</span><br><span class="line marked">    &#123;</span><br><span
                                        class="line marked">      <span class="attr hljs-attr">"PutRequest"</span>: &#123;</span><br><span
                                        class="line">        <span
                                        class="attr hljs-attr">"Item"</span>: &#123;</span><br><span class="line">          <span
                                        class="attr hljs-attr">"id"</span>: &#123; <span
                                        class="attr hljs-attr">"N"</span>: <span class="string hljs-string">"1"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"name"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span class="string hljs-string">"Bacon and egg pie"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"taste"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"savoury"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"main_ingredient"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"bacon"</span> &#125;</span><br><span class="line">        &#125;</span><br><span
                                        class="line">      &#125;</span><br><span
                                        class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span
                                        class="line">      <span
                                        class="attr hljs-attr">"PutRequest"</span>: &#123;</span><br><span class="line">        <span
                                        class="attr hljs-attr">"Item"</span>: &#123;</span><br><span class="line">          <span
                                        class="attr hljs-attr">"id"</span>: &#123; <span
                                        class="attr hljs-attr">"N"</span>: <span class="string hljs-string">"2"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"name"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"Scotch pie"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"taste"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"savoury"</span> &#125;,</span><br><span
                                        class="line">          <span class="attr hljs-attr">"main_ingredient"</span>: &#123; <span
                                        class="attr hljs-attr">"S"</span>: <span class="string hljs-string">"minced meat"</span> &#125;</span><br><span
                                        class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span
                                        class="line">    &#125;,</span><br><span
                                        class="line">    // truncated</span><br><span class="line">  ]</span><br><span
                                        class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>Execute <code>batch-write-item</code> to insert the data:</p>
                <figure class="highlight bash hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">aws dynamodb batch-write-item --request-items file://load-data-pies.json</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p></p>
                <p>Simplified result:</p>
                <div style="text-align:center;margin-bottom:2em"><img
                        src="/gallery/dynamodb-pagination-tale-or-expect-the-unexpected/pies-table.png"
                        class="align-right" width="500" height="500" title="Pies Table"></div>
                <h2 id="Let’s-try-filtering"><a href="#Let’s-try-filtering" class="headerlink"
                                                title="Let’s try filtering!"></a>Let’s try filtering!</h2>
                <p>DynamoDB defines two methods for data retrieval: <code>scan</code> and <code>query</code>. The
                    essential difference between them is that <code>scan</code> reads every item in the table and <code>query</code>
                    finds item(s) based on primary key values.</p>
                <p>However, that does not mean that the results of a <code>scan</code> operation can’t be further
                    filtered out. DynamoDB provides a <code>filter-expression</code> for that matter:</p>
                <figure class="highlight bash hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">aws dynamodb scan \</span><br><span class="line">     --table-name pies \</span><br><span
                                        class="line">     --filter-expression <span class="string hljs-string">"taste = :taste"</span> \</span><br><span
                                        class="line">     --expression-attribute-values <span
                                        class="string hljs-string">'&#123;":taste":&#123;"S":"sweet"&#125;&#125;'</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>In the <code>filter-expression</code> — the first part “taste” is the column name used for filtering
                    and “:taste” is the filter value. The filter value has to be defined in the <code>expression-attribute-values</code>.
                </p>
                <p>When we run that command we get the expected results. Just the 8 sweet pies.</p>
                <p>However, suppose you are a pie magnate that has a storage of thousands and thousands of pies
                    somewhere. Will you still get the data just the way you might expect?</p>
                <p>As your storage needs grow at some point you will face pagination. Pagination can be applied by you
                    manually or you might hit one of the default AWS default limits which is 1MB result set per Scan
                    operation call.</p>
                <blockquote class="colorquote info">DynamoDB limits are listed <a
                        href="https://docs.aws.amazon.com/amazondynamodb/latest/developerguide/Limits.html"
                        title="AWS DynamoDB Limits" target="_blank" rel="noopener">here</a><br>1MB limit can be
                    calculated based on record size.
                </blockquote>
                <p>We can also set a pagination limit by ourselves via the <code>--limit [number]</code> on the AWS CLI
                    command.</p>
                <p>Let’s try that out:</p>
                <figure class="highlight bash hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">aws dynamodb scan \</span><br><span class="line">     --table-name pies \</span><br><span
                                        class="line">     --<span class="built_in hljs-built_in">limit</span> 2 \</span><br><span
                                        class="line">     --filter-expression <span class="string hljs-string">"taste = :taste"</span> \</span><br><span
                                        class="line">     --expression-attribute-values <span
                                        class="string hljs-string">'&#123;":taste":&#123;"S":"sweet"&#125;&#125;'</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>It will produce an output like this:</p>
                <figure class="highlight json hljs">
                    <figcaption><span>Scan with limit result</span></figcaption>
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">&#123;</span><br><span class="line">    <span
                                        class="attr hljs-attr">"Items"</span>: [</span><br><span class="line">        &#123;</span><br><span
                                        class="line">            <span
                                        class="attr hljs-attr">"name"</span>: &#123;</span><br><span class="line">                <span
                                        class="attr hljs-attr">"S"</span>: <span class="string hljs-string">"Blueberry pie"</span></span><br><span
                                        class="line">            &#125;,</span><br><span class="line">            <span
                                        class="attr hljs-attr">"id"</span>: &#123;</span><br><span class="line">                <span
                                        class="attr hljs-attr">"N"</span>: <span
                                        class="string hljs-string">"9"</span></span><br><span class="line">            &#125;,</span><br><span
                                        class="line">            <span class="attr hljs-attr">"main_ingredient"</span>: &#123;</span><br><span
                                        class="line">                <span class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"blueberry"</span></span><br><span class="line">            &#125;,</span><br><span
                                        class="line">            <span
                                        class="attr hljs-attr">"taste"</span>: &#123;</span><br><span class="line">                <span
                                        class="attr hljs-attr">"S"</span>: <span
                                        class="string hljs-string">"sweet"</span></span><br><span class="line">            &#125;</span><br><span
                                        class="line">        &#125;</span><br><span class="line">    ],</span><br><span
                                        class="line">    <span class="attr hljs-attr">"Count"</span>: <span
                                        class="number hljs-number">1</span>,</span><br><span class="line">    <span
                                        class="attr hljs-attr">"ScannedCount"</span>: <span
                                        class="number hljs-number">2</span>,</span><br><span class="line">    <span
                                        class="attr hljs-attr">"LastEvaluatedKey"</span>: &#123;</span><br><span
                                        class="line">        <span
                                        class="attr hljs-attr">"name"</span>: &#123;</span><br><span class="line">            <span
                                        class="attr hljs-attr">"S"</span>: <span class="string hljs-string">"Blueberry pie"</span></span><br><span
                                        class="line">        &#125;,</span><br><span class="line">        <span
                                        class="attr hljs-attr">"id"</span>: &#123;</span><br><span class="line">            <span
                                        class="attr hljs-attr">"N"</span>: <span
                                        class="string hljs-string">"9"</span></span><br><span class="line">        &#125;</span><br><span
                                        class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>The <code>Items</code> section shows us what data DynamoDB has found when executing our query.</p>
                <p><em>Just 1 item! Not 2</em>.</p>
                <p>If we take a closer look at these two fields we will get an idea of what happened:</p>
                <figure class="highlight hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">"Count": 1</span><br><span class="line">"ScannedCount": 2</span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p></p>
                <p><code>Count</code> is how many items were left after filter was applied and that is what we see in
                    the final result.</p>
                <p><code>ScannedCount</code>, on the other hand, means how many items were scanned. It’s value is 2 just
                    like our <code>limit</code> value.</p>
                <blockquote class="colorquote danger">DynamoDB applies it's limits first and only THEN filters out the
                    result!
                </blockquote>
                <p>That poses a question on how to get the rest of the items if any limit is applied. As you can see
                    above we get <code>LastEvaluatedKey</code> which is the key of our next item. We can use that as a
                    starting position for executing our next <code>scan</code> request.</p>
                <h2 id="Solving-the-problem…"><a href="#Solving-the-problem…" class="headerlink"
                                                 title="Solving the problem…"></a>Solving the problem…</h2>
                <p>Manually:</p>
                <figure class="highlight bash hljs">
                    <table>
                        <tr>
                            <td class="code">
                                <pre><span class="line">aws dynamodb scan \</span><br><span class="line">     --table-name pies \</span><br><span
                                        class="line">     --<span class="built_in hljs-built_in">limit</span> 2 \</span><br><span
                                        class="line">     --filter-expression <span class="string hljs-string">"taste = :taste"</span> \</span><br><span
                                        class="line">     --expression-attribute-values <span
                                        class="string hljs-string">'&#123;":taste":&#123;"S":"sweet"&#125;&#125;'</span> \</span><br><span
                                        class="line">     --exclusive-start-key <span class="string hljs-string">'&#123;"name": &#123;"S": "Blueberry pie"&#125;, "id": &#123;"N": "9"&#125;&#125;'</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>… And repeat until we go through all the items in the database.</p>
                <p>Programmatically (NodeJS) it would look like this:</p>
                <figure class="highlight javascript hljs">
                    <figcaption><span>revised-solution.js</span></figcaption>
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                        class="line">3</span><br><span class="line">4</span><br><span
                                        class="line">5</span><br><span class="line">6</span><br><span
                                        class="line">7</span><br><span class="line">8</span><br><span
                                        class="line">9</span><br><span class="line">10</span><br><span
                                        class="line">11</span><br><span class="line">12</span><br><span
                                        class="line">13</span><br><span class="line">14</span><br><span
                                        class="line">15</span><br><span class="line">16</span><br><span
                                        class="line">17</span><br><span class="line">18</span><br><span
                                        class="line">19</span><br><span class="line">20</span><br><span
                                        class="line">21</span><br><span class="line">22</span><br><span
                                        class="line">23</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment hljs-comment">// Params to pass to DynamoDB scan</span></span><br><span
                                        class="line"><span class="keyword hljs-keyword">const</span> sweetPiesFilter = &#123;</span><br><span
                                        class="line">    ExpressionAttributeValues: &#123; <span
                                        class="string hljs-string">':taste'</span>: &#123; <span class="attr hljs-attr">S</span>: <span
                                        class="string hljs-string">'sweet'</span> &#125; &#125;,</span><br><span
                                        class="line">    FilterExpression: <span class="string hljs-string">'taste = :taste'</span>,</span><br><span
                                        class="line">    TableName: <span
                                        class="string hljs-string">'pies'</span></span><br><span
                                        class="line">&#125;</span><br><span class="line"></span><br><span
                                        class="line"><span class="keyword hljs-keyword">async</span> scan(params, resultSet = []) &#123;</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> [Items, LastEvaluatedKey] = <span
                                        class="keyword hljs-keyword">await</span> db.scan(params).promise()</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> result = [...resultSet, ...Items]</span><br><span
                                        class="line"></span><br><span class="line">    <span
                                        class="comment hljs-comment">// If there are more items to fetch then we should do that</span></span><br><span
                                        class="line">    <span class="keyword hljs-keyword">if</span> (LastEvaluatedKey) &#123;</span><br><span
                                        class="line">        <span class="keyword hljs-keyword">const</span> updatedParams = <span
                                        class="built_in hljs-built_in">Object</span>.assign(&#123;&#125;, params, &#123; <span
                                        class="attr hljs-attr">ExclusiveStartKey</span>: LastEvaluatedKey &#125;)</span><br><span
                                        class="line">        <span class="keyword hljs-keyword">await</span> read(updatedParams, result);</span><br><span
                                        class="line">    &#125;</span><br><span class="line">    <span
                                        class="keyword hljs-keyword">return</span> result</span><br><span class="line">&#125;</span><br><span
                                        class="line"></span><br><span class="line"><span class="keyword hljs-keyword">const</span> allSweetPies = <span
                                        class="keyword hljs-keyword">await</span> scan(sweetPiesFilter) <span
                                        class="comment hljs-comment">// 8</span></span><br><span
                                        class="line"></span><br><span class="line"><span class="keyword hljs-keyword">const</span> onlyFiveSweetPiesFilter = <span
                                        class="built_in hljs-built_in">Object</span>.assign(&#123;&#125;, sweetPiesFilter, &#123; <span
                                        class="attr hljs-attr">Limit</span>: <span class="number hljs-number">5</span> &#125;)</span><br><span
                                        class="line"><span class="keyword hljs-keyword">const</span> onlyFiveSweetPies = <span
                                        class="keyword hljs-keyword">await</span> scan(onlyFiveSweetPiesFilter) <span
                                        class="comment hljs-comment">// Still 8!</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>However, there’s a problem with this script.</p>
                <p>Suppose we actually need to limit our data to a certain pagination limit precisely. Say 10.</p>
                <p>Loop until you get 10 items if they are present and then break out of the loop.</p>
                <h2 id="Revised-solution"><a href="#Revised-solution" class="headerlink" title="Revised solution"></a>Revised
                    solution</h2>
                <figure class="highlight javascript hljs">
                    <figcaption><span>revised-solution.js</span></figcaption>
                    <table>
                        <tr>
                            <td class="gutter">
                                <pre><span class="line">1</span><br><span class="line">2</span><br><span
                                        class="line">3</span><br><span class="line">4</span><br><span
                                        class="line">5</span><br><span class="line">6</span><br><span
                                        class="line">7</span><br><span class="line">8</span><br><span
                                        class="line">9</span><br><span class="line">10</span><br><span
                                        class="line">11</span><br><span class="line">12</span><br><span
                                        class="line">13</span><br><span class="line">14</span><br><span
                                        class="line">15</span><br><span class="line">16</span><br><span
                                        class="line">17</span><br><span class="line">18</span><br><span
                                        class="line">19</span><br><span class="line">20</span><br><span
                                        class="line">21</span><br><span class="line">22</span><br><span
                                        class="line">23</span><br><span class="line">24</span><br><span
                                        class="line">25</span><br><span class="line">26</span><br><span
                                        class="line">27</span><br></pre>
                            </td>
                            <td class="code">
                                <pre><span class="line"><span class="comment hljs-comment">// Params to pass to DynamoDB scan</span></span><br><span
                                        class="line"><span class="keyword hljs-keyword">const</span> sweetPiesFilter = &#123;</span><br><span
                                        class="line">    ExpressionAttributeValues: &#123; <span
                                        class="string hljs-string">':taste'</span>: &#123; <span class="attr hljs-attr">S</span>: <span
                                        class="string hljs-string">'sweet'</span> &#125; &#125;,</span><br><span
                                        class="line">    FilterExpression: <span class="string hljs-string">'taste = :taste'</span>,</span><br><span
                                        class="line">    TableName: <span
                                        class="string hljs-string">'pies'</span></span><br><span
                                        class="line">&#125;</span><br><span class="line"></span><br><span
                                        class="line"><span class="keyword hljs-keyword">async</span> scan(params, enforcedLimit, resultSet = []) &#123;</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> [Items, LastEvaluatedKey] = <span
                                        class="keyword hljs-keyword">await</span> db.scan(params).promise()</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> result = [...resultSet, ...Items]</span><br><span
                                        class="line"></span><br><span class="line">    <span
                                        class="comment hljs-comment">// Determine if we need to fetch more items </span></span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> noEnforcedLimit = !enforcedLimit</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> enforcedLimitNotReached = enforcedLimit &amp;&amp; result.length &lt; enforcedLimit</span><br><span
                                        class="line">    <span class="keyword hljs-keyword">const</span> shouldGetMoreItems = LastEvaluatedKey &amp;&amp; noEnforcedLimit &amp;&amp; enforcedLimitNotReached</span><br><span
                                        class="line"></span><br><span class="line">    <span
                                        class="keyword hljs-keyword">if</span> (shouldGetMoreItems) &#123;</span><br><span
                                        class="line">        <span class="keyword hljs-keyword">const</span> updatedParams = <span
                                        class="built_in hljs-built_in">Object</span>.assign(&#123;&#125;, params, &#123; <span
                                        class="attr hljs-attr">ExclusiveStartKey</span>: scanResult.LastEvaluatedKey &#125;)</span><br><span
                                        class="line">        <span class="keyword hljs-keyword">await</span> read(updatedParams, [...resultSet, ...scanResult.Items]);</span><br><span
                                        class="line">    &#125;</span><br><span class="line">    </span><br><span
                                        class="line">    <span class="comment hljs-comment">// Discard items if there are more than we want</span></span><br><span
                                        class="line">    <span class="keyword hljs-keyword">return</span> enforcedLimit ? result.slice(<span
                                        class="number hljs-number">0</span>, enforcedLimit) : result</span><br><span
                                        class="line">&#125;</span><br><span class="line"></span><br><span
                                        class="line"><span class="keyword hljs-keyword">const</span> onlyFiveSweetPies = <span
                                        class="keyword hljs-keyword">await</span> scan(sweetPiesFilter, <span
                                        class="number hljs-number">5</span>) <span
                                        class="comment hljs-comment">// 5</span></span><br><span class="line"><span
                                        class="keyword hljs-keyword">const</span> onlyTenSweetPies = <span
                                        class="keyword hljs-keyword">await</span> scan(sweetPiesFilter, <span
                                        class="number hljs-number">10</span>) <span class="comment hljs-comment">// 8. That's all there is</span></span><br></pre>
                            </td>
                        </tr>
                    </table>
                </figure>
                <p>Bingo!</p>
                <h2 id="Takeaways"><a href="#Takeaways" class="headerlink" title="Takeaways"></a>Takeaways</h2>
                <p>Be careful about your assumptions on command’s parameter names and read the official documentation
                    carefully.</p>
                <p>Also, try out the code above :)</p></div>
            <div class="columns is-variable is-1 is-multiline is-mobile"><span class="column is-narrow"><a
                    class="tag is-light article-tag" href="/tags/dynamodb/">#dynamodb</a></span> <span
                    class="column is-narrow"><a class="tag is-light article-tag" href="/tags/aws/">#aws</a></span></div>
        </article>
        <div class="sharebox">
            <div class="addthis_inline_share_toolbox"></div>
            <script type="text/javascript"
                    src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b97d76504deb62c"></script>
        </div>
        <div class="comments"><h3 class="title is-4">Comments</h3>
            <script>var disqus_config = function () {
                this.page.url = "https://jelena.lv/2018/12/08/dynamodb-pagination-tale-or-expect-the-unexpected/", this.page.identifier = "2018/12/08/dynamodb-pagination-tale-or-expect-the-unexpected/", this.language = "en"
            };
            !function () {
                var e = document, t = e.createElement("script");
                t.src = "//jelenalv.disqus.com/embed.js", t.setAttribute("data-timestamp", +new Date), (e.head || e.body).appendChild(t)
            }()</script>
            <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
            </div>
        </div>
    </div>
</section>
<footer class="footer">
    <div class="container">
        <div class="columns content">
            <div class="column is-narrow has-text-centered">&copy; 2018 Jelena&nbsp; Powered by <a
                    href="http://hexo.io/" target="_blank">Hexo</a> & <a
                    href="http://github.com/ppoffice/hexo-theme-minos">Minos</a></div>
            <div class="column is-hidden-mobile"></div>
        </div>
    </div>
</footer>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment-with-locales.min.js"></script>
<div id="outdated"><h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/">Update
        my browser now</a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p></div>
<script src="//cdnjs.cloudflare.com/ajax/libs/outdated-browser/1.1.5/outdatedbrowser.min.js"></script>
<script>$(document).ready(function () {
    outdatedBrowser({bgColor: "#f25648", color: "#ffffff", lowerThan: "flex"})
})</script>
<script>window.FontAwesomeConfig = {searchPseudoElements: !0}, moment.locale("en-AU")</script>
<script src="//cdnjs.cloudflare.com/ajax/libs/lightgallery/1.6.8/js/lightgallery-all.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/justifiedGallery/3.6.5/js/jquery.justifiedGallery.min.js"></script>
<script>!function (e) {
    e(document).ready(function () {
        "function" == typeof e.fn.lightGallery && e(".article.gallery").lightGallery({selector: ".gallery-item"}), "function" == typeof e.fn.justifiedGallery && e(".justified-gallery").justifiedGallery()
    })
}(jQuery)</script>
<script src="/js/script.js"></script>
<div class="searchbox ins-search">
    <div class="searchbox-mask"></div>
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper"><input type="text" class="searchbox-input ins-search-input"
                                                    placeholder="Type something..."> <span
                class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span></div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>window.INSIGHT_CONFIG = {
    TRANSLATION: {
        POSTS: "Posts",
        PAGES: "Pages",
        CATEGORIES: "Categories",
        TAGS: "Tags",
        UNTITLED: "(Untitled)"
    }, CONTENT_URL: "/content.json"
}</script>
<script src="/js/insight.js"></script>
</body>
</html>
